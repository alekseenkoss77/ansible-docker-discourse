templates:
  - "templates/postgres.template.yml"
  - "templates/redis.template.yml"
  - "templates/web.template.yml"
  - "templates/sshd.template.yml"
  - "templates/web.ratelimited.template.yml"

## which TCP/IP ports should this container expose?
expose:
  - "80:80"
  - "2222:22"

# any extra arguments for Docker?
# docker_args:

params:
  db_default_text_search_config: {{ discourse_app.db.search_conf }}

  ## Set db_shared_buffers to a max of 25% of the total memory.
  ## On 1GB installs set to 128MB (to leave room for other processes)
  ## on a 4GB instance you may raise to 1GB
  db_shared_buffers: {{ discourse_app.db.db_shared_buffers }}

  ## Set higher on large instances it defaults to 10MB, for a 3GB install 40MB is a good default
  ## this improves sorting performance, but adds memory usage per-connection
  db_work_mem: {{ discourse_app.db.db_work_mem }}

  ## Which Git revision should this container use? (default: tests-passed)
  version: {{ discourse_app.git_revision }}

env:
  LANG: {{ discourse_app.lang }}
  DISCOURSE_DEFAULT_LOCALE: {{ discourse_app.default_locale }}
  UNICORN_WORKERS: {{ discourse_app.unicorn_workers }}
  DISCOURSE_DEVELOPER_EMAILS: '{{ discourse_app.admins|join(",") }}'
  DISCOURSE_HOSTNAME: '{{ discourse_app.hostname }}'
  DISCOURSE_SMTP_ADDRESS: {{ discourse_app.smtp.address }}
  DISCOURSE_SMTP_PORT: {{ discourse_app.smtp.port }}
  DISCOURSE_SMTP_USER_NAME: {{ discourse_app.smtp.user }}
  DISCOURSE_SMTP_PASSWORD: {{ discourse_app.smtp.pass }}
  DISCOURSE_SMTP_ENABLE_START_TLS: {{ discourse_app.smtp.tls }}
  DISCOURSE_CDN_URL: {{ discourse_app.cdn_url }}

volumes:
  - volume:
      host: {{ discourse_app.root_path }}/shared/standalone
      guest: /shared
  - volume:
      host: {{ discourse_app.root_path }}/shared/standalone/log/var-log
      guest: /var/log

hooks:
  after_code:
    - exec:
        cd: $home/plugins
        cmd:
          - mkdir -p plugins
          - git clone https://github.com/discourse/docker_manager.git

run:
  - exec: echo "Beginning of custom commands"
  - exec: echo "End of custom commands"
  - exec: awk -F\# '{print $1;}' ~/.ssh/authorized_keys | awk 'BEGIN { print "Authorized SSH keys for this container:"; } NF>=2 {print $NF;}'
